{"ast":null,"code":"const _require = require('assert'),\n      assert = _require.strict;\n\nconst _require2 = require('crypto'),\n      createCipheriv = _require2.createCipheriv,\n      createDecipheriv = _require2.createDecipheriv;\n\nconst _require3 = require('../help/consts'),\n      KEYOBJECT = _require3.KEYOBJECT;\n\nconst _require4 = require('../errors'),\n      JWEInvalid = _require4.JWEInvalid,\n      JWEDecryptionFailed = _require4.JWEDecryptionFailed;\n\nconst _require5 = require('../help/key_object'),\n      asInput = _require5.asInput;\n\nconst checkInput = function (size, iv, tag) {\n  if (iv.length !== 12) {\n    throw new JWEInvalid('invalid iv');\n  }\n\n  if (arguments.length === 3) {\n    if (tag.length !== 16) {\n      throw new JWEInvalid('invalid tag');\n    }\n  }\n};\n\nconst encrypt = (size, {\n  [KEYOBJECT]: keyObject\n}, cleartext, {\n  iv,\n  aad = Buffer.alloc(0)\n}) => {\n  const key = asInput(keyObject, false);\n  checkInput(size, iv);\n  const cipher = createCipheriv(\"aes-\".concat(size, \"-gcm\"), key, iv);\n  cipher.setAAD(aad);\n  const ciphertext = Buffer.concat([cipher.update(cleartext), cipher.final()]);\n  const tag = cipher.getAuthTag();\n  return {\n    ciphertext,\n    tag\n  };\n};\n\nconst decrypt = (size, {\n  [KEYOBJECT]: keyObject\n}, ciphertext, {\n  iv,\n  tag = Buffer.alloc(0),\n  aad = Buffer.alloc(0)\n}) => {\n  const key = asInput(keyObject, false);\n  checkInput(size, iv, tag);\n\n  try {\n    const cipher = createDecipheriv(\"aes-\".concat(size, \"-gcm\"), key, iv);\n    cipher.setAuthTag(tag);\n    cipher.setAAD(aad);\n    return Buffer.concat([cipher.update(ciphertext), cipher.final()]);\n  } catch (err) {\n    throw new JWEDecryptionFailed();\n  }\n};\n\nmodule.exports = JWA => {\n  ['A128GCM', 'A192GCM', 'A256GCM'].forEach(jwaAlg => {\n    const size = parseInt(jwaAlg.substr(1, 3), 10);\n    assert(!JWA.encrypt.has(jwaAlg), \"encrypt alg \".concat(jwaAlg, \" already registered\"));\n    assert(!JWA.decrypt.has(jwaAlg), \"decrypt alg \".concat(jwaAlg, \" already registered\"));\n    JWA.encrypt.set(jwaAlg, encrypt.bind(undefined, size));\n    JWA.decrypt.set(jwaAlg, decrypt.bind(undefined, size));\n  });\n};","map":null,"metadata":{},"sourceType":"script"}